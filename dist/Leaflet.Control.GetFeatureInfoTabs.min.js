/*! Version: 0.0.1
Copyright (c) 2018 Federico Sanchez */

L.Control.GetFeatureInfoTabs=L.Evented.extend({options:{popupOptions:{minWidth:600,autoPan:!0,keepInView:!1}},popup:null,requested_layers:null,done_requests:null,something_to_show:!1,template_popup:"<div class='row' id='loading-wmsgetfeatureinfo-requests'>  <span class='glyphicon glyphicon-refresh glyphicon-spin'></span> Loading ... </div><div class='row'><div class='col-sm-8'><div class='tab-content'>{tabs}</div></div><div class='col-sm-4'><ul class='nav nav-pills nav-stacked'>{tabs_content}</ul></div></div>",template_tab_pane:"<div id='tab-{index}' class='tab-pane fade {active}'></div>",template_tab_content:"<li class='{active}'><a data-toggle='tab' href='#tab-{index}'>{title}</a></li>",template_features_table:"<table class='table table-hover'> {rows} </table>",template_feature_row:"<tr><td><b>{key}</b></td><td>{value}</td></tr>",initialize:function(t){L.Util.setOptions(this,t)},addTo:function(t){return this.remove(),this._map=t,this._map.on("click",this.getFeatureInfo,this),this},remove:function(){return this._map&&(this._map.off("click",this.getFeatureInfo,this),this._map=null),this},hideLoading:function(){$("#loading-wmsgetfeatureinfo-requests").hide()},updateStatus:function(){var t=this;t.done_requests++,t.requested_layers==t.done_requests&&(t.something_to_show||($("#loading-wmsgetfeatureinfo-requests").html("  No se encontr√≥ contenido para mostrar ..."),setTimeout(function(){t.popup.removeFrom(t._map)},1e3)))},getFeatureInfo:function(a){this.popup&&this.popup.removeFrom(this._map),this.done_requests=0,this.something_to_show=!1;var s=this,i=[],n=[],o=[],r=0;if(this._map.eachLayer(function(t){if(t.wmsParams){var e=s.tabInfo(t,a.latlng);e.index=r,e.active="hidden",n.push(L.Util.template(s.template_tab_pane,e)),o.push(L.Util.template(s.template_tab_content,e)),i.push(e),r++}}),this.requested_layers=r,0<this.requested_layers){var t={tabs:n.join(""),tabs_content:o.join("")},e=L.Util.template(this.template_popup,t);for(var l in i)this.queryLayer(i[l].url,i[l].index);this.popup=L.popup(this.options.popupOptions).setLatLng(a.latlng).setContent(e).openOn(this._map)}},tabInfo:function(t,e){return{title:t.options.title?t.options.title:t.wmsParams.layers,url:this.getFeatureInfoUrl(t,e)}},queryLayer:function(t,o){var r="#tab-"+o,l=this;$.getJSON(t,function(t){if(0<t.features.length){var e=t.features[0].properties,a=[];for(key in e)if(""!==e[key]&&null!==e[key]){var s=e[key];a.push(L.Util.template(l.template_feature_row,{key:key,value:s}))}var i=L.Util.template(l.template_features_table,{rows:a.join("")}),n='a[href$="#tab-'+o+'"]';$(n).parent().removeClass("hidden"),$(r).removeClass("hidden"),$(n).click(),l.something_to_show=!0,l.hideLoading()}else i="sin resultados";$(r).html(i),l.updateStatus()})},getFeatureInfoUrl:function(t,e){var a=this._map.latLngToContainerPoint(e,this._map.getZoom()),s=this._map.getSize(),i={request:"GetFeatureInfo",service:"WMS",srs:"EPSG:4326",styles:t.wmsParams.styles,transparent:t.wmsParams.transparent,version:t.wmsParams.version,format:t.wmsParams.format,bbox:this._map.getBounds().toBBoxString(),height:s.y,width:s.x,layers:t.wmsParams.layers,query_layers:t.wmsParams.layers,info_format:"application/json"};return t.wmsParams.cql_filter&&(i.cql_filter=t.wmsParams.cql_filter),t.wmsParams.viewparams&&(i.viewparams=t.wmsParams.viewparams),i["1.3.0"===i.version?"i":"x"]=a.x,i["1.3.0"===i.version?"j":"y"]=a.y,t._url+L.Util.getParamString(i,t._url,!0)}}),L.control.getfeatureinfotabs=function(t){return new L.Control.GetFeatureInfoTabs(t)};